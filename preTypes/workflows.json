[
  {
    "model": "workflows.workflow",
    "pk": 10,
    "fields": {
      "label": "Aufbewahrungsfristen + Rechtssperre + Vererbung + selektive Eingrenzung",
      "document_types": ["*"]
    }
  },
  {
    "model": "workflows.workflowstate",
    "pk": 101,
    "fields": {
      "workflow": 10,
      "label": "Eingang",
      "initial": true
    }
  },
  {
    "model": "workflows.workflowtransition",
    "pk": 101,
    "fields": {
      "workflow": 10,
      "label": "Fristen prüfen & markieren",
      "origin_state": 101,
      "destination_state": 101,
      "condition": "{% if document.metadata_value_of.buchungsjahr|default:'' == '2025' or document.metadata_value_of.buchungsquartal|default:'' == 'Q2' or 'Müller' in document.metadata_value_of.kunde|default:'' or 'Shopify' in document.metadata_value_of.datenquelle|default:'' %}True{% else %}False{% endif %}",
      "action": [
        {
          "action_type": "tag_attach",
          "tag": "retention_expired",
          "condition": "{% if document.metadata_value_of.legal_hold_until and document.metadata_value_of.legal_hold_until|date:'Y-m-d' > 'now'|date:'Y-m-d' %}False{% elif document.metadata_value_of.retention_date and document.metadata_value_of.retention_date|date:'Y-m-d' < 'now'|date:'Y-m-d' %}True{% else %}False{% endif %}"
        },
        {
          "action_type": "tag_attach",
          "tag": "legal_hold_active",
          "condition": "{% if document.metadata_value_of.legal_hold_until and document.metadata_value_of.legal_hold_until|date:'Y-m-d' > 'now'|date:'Y-m-d' %}True{% else %}False{% endif %}"
        },
        {
          "action_type": "tag_propagate",
          "tag": "retention_expired",
          "direction": "both"
        },
        {
          "action_type": "tag_propagate",
          "tag": "legal_hold_active",
          "direction": "both"
        }
      ]
    }
  },

  {
    "model": "workflows.workflow",
    "pk": 20,
    "fields": {
      "label": "DSGVO Feedback-Freigabe + Widerruf + Rechtssperre",
      "document_types": ["correspondence", "customer_feedback"]
    }
  },
  {
    "model": "workflows.workflowstate",
    "pk": 201,
    "fields": {
      "workflow": 20,
      "label": "Eingang",
      "initial": true,
      "completion": null
    }
  },
  {
    "model": "workflows.workflowtransition",
    "pk": 201,
    "fields": {
      "workflow": 20,
      "label": "Freigabe prüfen → Sperre setzen/entfernen",
      "origin_state": 201,
      "destination_state": 201,
      "condition": "True",
      "action": [
        {
          "action_type": "tag_remove",
          "tag": "legal_hold_active",
          "condition": "True"
        },
        {
          "action_type": "tag_attach",
          "tag": "legal_hold_active",
          "condition": "{% if document.metadata_value_of.consent_given_until and document.metadata_value_of.consent_given_until|date:'Y-m-d' > 'now'|date:'Y-m-d' and not document.metadata_value_of.consent_withdrawn %}True{% else %}False{% endif %}"
        },
        {
          "action_type": "tag_attach",
          "tag": "consent_withdrawn",
          "condition": "{% if document.metadata_value_of.consent_withdrawn %}True{% else %}False{% endif %}"
        }
      ]
    }
  },

  {
    "model": "workflows.workflowtransition",
    "pk": 301,
    "fields": {
      "workflow": 10,
      "label": "ZUGFeRD prüfen & Abgleich-Status setzen",
      "condition": "document.filename.endswith('.pdf')",
      "action": [
        {
          "action_type": "set_metadata",
          "metadata_type": "zugferd_extracted",
          "value": "Ja"
        },
        {
          "action_type": "tag_attach",
          "tag": "sync_pending",
          "condition": "document.metadata_value_of.sync_status == 'neu'"
        }
      ]
    }
  },

  {
  "action_type": "send_email",
  "subject": "Aufbewahrung abgelaufen: {{ document.label }}",
  "body": "Dokument {{ document.label }} ist löschbar. Prüfen Sie: {{ document.get_absolute_url }}",
  "to": "admin@ihrfirma.de",
  "condition": "{% if document.tag == 'retention_expired' %}True{% endif %}"
}
]
